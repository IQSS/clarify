<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Apply a function to simulated parameter values — sim_apply • clarify</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Apply a function to simulated parameter values — sim_apply"><meta name="description" content="sim_apply() applies a function that produces quantities of interest to each set of simulated coefficients produced by sim(); these calculated quantities form the posterior sampling distribution for the quantities of interest. Capabilities are available for parallelization."><meta property="og:description" content="sim_apply() applies a function that produces quantities of interest to each set of simulated coefficients produced by sim(); these calculated quantities form the posterior sampling distribution for the quantities of interest. Capabilities are available for parallelization."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">clarify</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/clarify.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/Zelig.html">Translating Zelig to clarify</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/iqss/clarify/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Apply a function to simulated parameter values</h1>
      <small class="dont-index">Source: <a href="https://github.com/iqss/clarify/blob/main/R/sim_apply.R" class="external-link"><code>R/sim_apply.R</code></a></small>
      <div class="d-none name"><code>sim_apply.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p><code>sim_apply()</code> applies a function that produces quantities of interest to each set of simulated coefficients produced by <code><a href="sim.html">sim()</a></code>; these calculated quantities form the posterior sampling distribution for the quantities of interest. Capabilities are available for parallelization.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">sim_apply</span><span class="op">(</span><span class="va">sim</span>, <span class="va">FUN</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span>, cl <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for class 'clarify_est'</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">x</span>, digits <span class="op">=</span> <span class="fl">4L</span>, max.ests <span class="op">=</span> <span class="fl">6L</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-sim">sim<a class="anchor" aria-label="anchor" href="#arg-sim"></a></dt>
<dd><p>a <code>clarify_sim</code> object; the output of a call to <code><a href="sim.html">sim()</a></code> or <code><a href="misim.html">misim()</a></code>.</p></dd>


<dt id="arg-fun">FUN<a class="anchor" aria-label="anchor" href="#arg-fun"></a></dt>
<dd><p>a function to be applied to each set of simulated coefficients. See Details.</p></dd>


<dt id="arg-verbose">verbose<a class="anchor" aria-label="anchor" href="#arg-verbose"></a></dt>
<dd><p><code>logical</code>; whether to display a text progress bar indicating progress and estimated time remaining for the procedure. Default is <code>TRUE</code>.</p></dd>


<dt id="arg-cl">cl<a class="anchor" aria-label="anchor" href="#arg-cl"></a></dt>
<dd><p>a cluster object created by <code><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">parallel::makeCluster()</a></code>, or an integer to indicate the number of child-processes (integer values are ignored on Windows) for parallel evaluations. See <code><a href="https://peter.solymos.org/pbapply/reference/pbapply.html" class="external-link">pbapply::pblapply()</a></code> for details. If <code>NULL</code>, no parallelization will take place.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>for <code>sim_apply()</code>, optional arguments passed to <code>FUN</code>. For <code><a href="https://rdrr.io/r/base/print.html" class="external-link">print()</a></code>, ignored.</p></dd>


<dt id="arg-x">x<a class="anchor" aria-label="anchor" href="#arg-x"></a></dt>
<dd><p>a <code>clarify_est</code> object.</p></dd>


<dt id="arg-digits">digits<a class="anchor" aria-label="anchor" href="#arg-digits"></a></dt>
<dd><p>the minimum number of significant digits to be used; passed to <code><a href="https://rdrr.io/r/base/print.dataframe.html" class="external-link">print.data.frame()</a></code>.</p></dd>


<dt id="arg-max-ests">max.ests<a class="anchor" aria-label="anchor" href="#arg-max-ests"></a></dt>
<dd><p>the maximum number of estimates to display.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A <code>clarify_est</code> object, which is a matrix with a column for each
estimated quantity and a row for each simulation. The original estimates
(<code>FUN</code> applied to the original coefficients or model fit object) are stored
in the attribute <code>"original"</code>. The <code>"sim_hash"</code> attribute contains the
simulation hash produced by <code><a href="sim.html">sim()</a></code>.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p><code>sim_apply()</code> applies a function, <code>FUN</code>, to each set of simulated coefficients, similar to <code><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply()</a></code>. This function should return a numeric vector containing one or more estimated quantities. This should be a named vector to more easily keep track of the meaning of each estimated quantity. Care should be taken to ensure that the returned vector is the same length each time <code>FUN</code> is called. <code>NA</code>s are allowed in the output but should be avoided if possible.</p>
<p>The arguments to <code>FUN</code> can be specified in a few ways. If <code>FUN</code> has an
argument called <code>coefs</code>, a simulated set of coefficients will be passed to
this argument, and <code>FUN</code> should compute and return a quantity based on the
coefficients (e.g., the difference between two coefficients if one wants to
test whether two coefficients are equal). If <code>FUN</code> has an argument called
<code>fit</code>, a model fit object of the same type as the one originally supplied
to <code><a href="sim.html">sim()</a></code> (e.g., an <code>lm</code> or <code>glm</code> object) will be passed to this argument,
where the coefficients of the fit object have been replaced by the
simulated coefficients generated by <code><a href="sim.html">sim()</a></code>, and <code>FUN</code> should compute and
return a quantity based on the model fit (e.g., a computation based on the
output of <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code>). If neither <code>coefs</code> nor <code>fit</code> are the names of
arguments to <code>FUN</code>, the model fit object with replaced coefficients will be
supplied to the first argument of <code>FUN</code>.</p>
<p>When custom coefficients are supplied to <code><a href="sim.html">sim()</a></code>, i.e., when the <code>coefs</code>
argument to <code><a href="sim.html">sim()</a></code> is not left at its default value, <code>FUN</code> must accept a
<code>coefs</code> argument and a warning will be thrown if it accepts a <code>fit</code>
argument. This is because <code>sim_apply()</code> does not know how to reconstruct
the original fit object with the new coefficients inserted. The quantities
computed by <code>sim_apply()</code> must therefore be computed directly from the
coefficients.</p>
<p>If <code>FUN</code> is not supplied at all, the simulated values of the coefficients will be returned in the output with a warning. Set <code>FUN</code> to <code>NULL</code> or <code>verbose</code> to <code>FALSE</code> to suppress this warning.</p><div class="section">
<h3 id="sim-apply-with-multiply-imputed-data"><code>sim_apply()</code> with multiply imputed data<a class="anchor" aria-label="anchor" href="#sim-apply-with-multiply-imputed-data"></a></h3>


<p>When using <code><a href="misim.html">misim()</a></code> and <code>sim_apply()</code> with multiply imputed data, the
coefficients are supplied to the model fit corresponding to the imputation
identifier associated with each set of coefficients, which means if <code>FUN</code>
uses a dataset extracted from a model (e.g., using <code><a href="https://easystats.github.io/insight/reference/get_data.html" class="external-link">insight::get_data()</a></code>), it will do so from the model fit in
the corresponding imputation.</p>
<p>The original estimates (see Value below) are computed as the mean of the
estimates across the imputations using the original coefficients averaged
across imputations. That is, first, the coefficients estimated in the
models in the imputed datasets are combined to form a single set of pooled
coefficients; then, for each imputation, the quantities of interest are
computed using the pooled coefficients; finally, the mean of the resulting
estimates across the imputations are taken as the "original" estimates.
Note this procedure is only valid for quantities with symmetric sampling
distributions, which excludes quantities like risk ratios and odds ratios,
but includes log risk ratios and log odds ratios. The desired quantities
can be transformed from their log versions using
<code><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform()</a></code>.</p>
</div>

    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index">
<ul><li><p><code><a href="sim.html">sim()</a></code> for generating the simulated coefficients</p></li>
<li><p><code><a href="summary.clarify_est.html">summary.clarify_est()</a></code> for computing p-values and confidence intervals for
the estimated quantities</p></li>
<li><p><code><a href="summary.clarify_est.html">plot.clarify_est()</a></code> for plotting estimated
quantities and their simulated posterior sampling distribution.</p></li>
</ul></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"lalonde"</span>, package <span class="op">=</span> <span class="st">"MatchIt"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">re78</span> <span class="op">~</span> <span class="va">treat</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">nodegree</span> <span class="op">+</span> <span class="va">re74</span>,</span></span>
<span class="r-in"><span>          data <span class="op">=</span> <span class="va">lalonde</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   (Intercept)         treat           age    racehispan     racewhite </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  4596.7282858  1719.6323705    -6.5455292  1605.6558582  1338.9751895 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      nodegree          re74 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> -1174.9861400     0.3855893 </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="sim.html">sim</a></span><span class="op">(</span><span class="va">fit</span>, n <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Function to compare predicted values for two units</span></span></span>
<span class="r-in"><span><span class="co"># using `fit` argument</span></span></span>
<span class="r-in"><span><span class="va">sim_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">fit</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="va">pred1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit</span>, newdata <span class="op">=</span> <span class="va">lalonde</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">pred2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit</span>, newdata <span class="op">=</span> <span class="va">lalonde</span><span class="op">[</span><span class="fl">2</span>,<span class="op">]</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>pred1 <span class="op">=</span> <span class="va">pred1</span>, pred2 <span class="op">=</span> <span class="va">pred2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">est</span> <span class="op">&lt;-</span> <span class="fu">sim_apply</span><span class="op">(</span><span class="va">s</span>, <span class="va">sim_fun</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Add difference between predicted values as</span></span></span>
<span class="r-in"><span><span class="co"># additional quantity</span></span></span>
<span class="r-in"><span><span class="va">est</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="va">est</span>, `diff 1-2` <span class="op">=</span> <span class="va">pred1</span> <span class="op">-</span> <span class="va">pred2</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Examine estimates and confidence intervals</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">est</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          Estimate 2.5 % 97.5 %</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> pred1        4899  3611   6365</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> pred2        6603  4469   8689</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> diff 1-2    -1704 -3867    651</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Function to compare coefficients using `coefs`</span></span></span>
<span class="r-in"><span><span class="co"># argument</span></span></span>
<span class="r-in"><span><span class="va">sim_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">coefs</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="va">coefs</span><span class="op">[</span><span class="st">"racewhite"</span><span class="op">]</span> <span class="op">-</span> <span class="va">coefs</span><span class="op">[</span><span class="st">"racehispan"</span><span class="op">]</span>,</span></span>
<span class="r-in"><span>           <span class="st">"wh - his"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">est</span> <span class="op">&lt;-</span> <span class="fu">sim_apply</span><span class="op">(</span><span class="va">s</span>, <span class="va">sim_fun</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Examine estimates and confidence intervals</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">est</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          Estimate 2.5 % 97.5 %</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> wh - his     -267 -1887   1418</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Another way to do the above:</span></span></span>
<span class="r-in"><span><span class="va">est</span> <span class="op">&lt;-</span> <span class="fu">sim_apply</span><span class="op">(</span><span class="va">s</span>, FUN <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">est</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="va">est</span>,</span></span>
<span class="r-in"><span>                 `wh - his` <span class="op">=</span> <span class="va">`racewhite`</span> <span class="op">-</span> <span class="va">`racehispan`</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">est</span>, parm <span class="op">=</span> <span class="st">"wh - his"</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          Estimate 2.5 % 97.5 %</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> wh - his     -267 -1887   1418</span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Noah Greifer, Steven Worthington, Stefano Iacus, Gary King.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

