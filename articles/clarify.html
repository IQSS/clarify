<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="clarify">
<title>clarify • clarify</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="clarify">
<meta property="og:description" content="clarify">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">clarify</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item">
  <a class="nav-link" href="../articles/clarify.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Zelig.html">Translating Zelig to clarify</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/iqss/clarify/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>clarify</h1>
            
            <h4 data-toc-skip class="date">2023-01-17</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/iqss/clarify/blob/HEAD/vignettes/clarify.Rmd" class="external-link"><code>vignettes/clarify.Rmd</code></a></small>
      <div class="d-none name"><code>clarify.Rmd</code></div>
    </div>

    
    
<div class="section level3">
<h3 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h3>
<p>Although regression models are frequently used in empirical research
to study relationships among variables, often the quantity of
substantive interest is not one of the coefficients of the model, but
rather a quantity derived from the coefficients, such as predicted
values or average marginal effects. The usual method for estimating the
uncertainty of the derived quantities is an approximation known as the
“delta method”. The delta method involves two approximations: 1) that
the variance of the derived quantity can be represented as a first-order
Taylor series, and 2) that the resulting estimate is normally
distributed<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;In addition, most software that uses the delta method
uses numerical differentiation, which also involves an approximation.&lt;/p&gt;"><sup>1</sup></a>.In many cases, especially with nonlinear
models, these approximation can fail badly. <code>clarify</code>
implements an alternative to the delta method—simulation-based
inference—which involves simulating the sampling distributions of the
derived quantities.</p>
<p>The methodology <code>clarify</code> relies on is described in <span class="citation">King, Tomz, and Wittenberg (2000)</span>. Similar
functionality exists in the <code>clarify</code> package in Stata <span class="citation">(Tomz, Wittenberg, and King 2003)</span> and used to be
available in the <code>Zelig</code> R package <span class="citation">(Imai, King, and Lau 2008)</span> .
<code>clarify</code> provides additional flexibility by allowing the
user to request any derived quantity, in addition to providing shortcuts
for common quantities, including predictions at representative values,
average marginal effects, and average dose-response functions (described
below). <code>clarify</code> relies on and can be seen as a companion to
the <code>marginaleffects</code> package, which offers similar
functionality but uses the delta method for its calculations.</p>
</div>
<div class="section level3">
<h3 id="using-clarify">Using <code>clarify</code><a class="anchor" aria-label="anchor" href="#using-clarify"></a>
</h3>
<p>There are four steps to using <code>clarify</code>:</p>
<ol style="list-style-type: decimal">
<li><p>Fit the model to the data using modeling functions in supported
packages</p></li>
<li><p>Use <code><a href="../reference/sim.html">sim()</a></code> to take draws from the sampling
distribution of the estimated model coefficients</p></li>
<li><p>Use <code><a href="../reference/sim_apply.html">sim_apply()</a></code> or its wrappers
<code><a href="../reference/sim_setx.html">sim_setx()</a></code>, <code><a href="../reference/sim_ame.html">sim_ame()</a></code>, and
<code><a href="../reference/sim_adrf.html">sim_adrf()</a></code> to compute derived quantities using each
simulated set of coefficients</p></li>
<li><p>Use <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> and <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> to summarize
and visualize the distribution of the derived quantities and perform
inference on them</p></li>
</ol>
<p>In the sections below, we’ll describe how to implement these steps in
detail. First, we’ll load <code>clarify</code> using
<code><a href="https://rdrr.io/r/base/library.html" class="external-link">library()</a></code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/iqss/clarify" class="external-link">clarify</a></span><span class="op">)</span></span></code></pre></div>
<p>For a running example, we’ll use the <code>lalonde</code> dataset in
the <code>MatchIt</code> package, which contains data on 614
participants enrolled in a job training program or sampled from a
survey. The treatment variable is <code>treat</code> and the outcome is
<code>re78</code>, and all other variables are confounders. Although the
original intent was to estimate the effect of <code>treat</code> on
<code>re78</code>, we’ll use it more generally to demonstrate all of
<code>clarify</code>’s capabilities. In addition, we’ll use a
transformation of the outcome variable to demonstrate applications to
nonlinear models.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"lalonde"</span>, package <span class="op">=</span> <span class="st">"MatchIt"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lalonde</span><span class="op">$</span><span class="va">re78_0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">lalonde</span><span class="op">$</span><span class="va">re78</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">lalonde</span><span class="op">)</span></span>
<span><span class="co">#&gt;      treat age educ   race married nodegree re74 re75       re78 re78_0</span></span>
<span><span class="co">#&gt; NSW1     1  37   11  black       1        1    0    0  9930.0460      0</span></span>
<span><span class="co">#&gt; NSW2     1  22    9 hispan       0        1    0    0  3595.8940      0</span></span>
<span><span class="co">#&gt; NSW3     1  30   12  black       0        0    0    0 24909.4500      0</span></span>
<span><span class="co">#&gt; NSW4     1  27   11  black       0        1    0    0  7506.1460      0</span></span>
<span><span class="co">#&gt; NSW5     1  33    8  black       0        1    0    0   289.7899      0</span></span>
<span><span class="co">#&gt; NSW6     1  22    9  black       0        1    0    0  4056.4940      0</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fitting-the-model">1. Fitting the model<a class="anchor" aria-label="anchor" href="#fitting-the-model"></a>
</h3>
<p>The first step is to fit the model. <code>clarify</code> can operate
on a large set of models (those supported by
<code>marginaleffects</code>), including generalized linear models,
multinomial models, multivariate models, and instrumental variable
models, many of which are available in other R packages. Even if
<code>clarify</code> does not offer direct support for a given model,
there are ways to use its functionality regardless (explained in more
detail below).</p>
<p>Because we are computing derived quantities, it is not critical to
parameterize the model in such a way that the coefficients are
interpretable. Below, we’ll fit a probit regression model for the
outcome given the treatment and confounders.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">re78_0</span> <span class="op">~</span> <span class="va">treat</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span></span>
<span>             <span class="va">nodegree</span> <span class="op">+</span> <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span>, data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>           family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span><span class="st">"probit"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Coefficients in probit regression do not have a straightforward
interpretation, but that’s okay; our quantities of interest can be
expressed as derived quantities–functions of the model parameters, such
as predictions, counterfactual predictions, and averages and contrasts
of them.</p>
</div>
<div class="section level3">
<h3 id="drawing-from-the-coefficient-distribution">2. Drawing from the coefficient distribution<a class="anchor" aria-label="anchor" href="#drawing-from-the-coefficient-distribution"></a>
</h3>
<p>After fitting the model, we will use <code><a href="../reference/sim.html">sim()</a></code> to draw
coefficients from their sampling distribution. The sampling distribution
is assumed to be multivariate normal or multivariate t with appropriate
degrees of freedom, with a mean vector equal to the coefficient vector
and a covariance matrix equal to the asymptotic covariance matrix
extracted from the model. The arguments to <code><a href="../reference/sim.html">sim()</a></code> are listed
below:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/sim.html">sim</a></span><span class="op">(</span>fit <span class="op">=</span> , n <span class="op">=</span> , vcov <span class="op">=</span> , coefs <span class="op">=</span> , dist <span class="op">=</span> <span class="op">)</span></span></code></pre></div>
<ul>
<li><p><code>fit</code> – the fitted model object, the output of the
call to the fitting function (e.g., <code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm()</a></code>)</p></li>
<li><p><code>n</code> – the number of simulated values to draw; by
default, 1000. More values will yield more replicable and precise
results at the cost of speed.</p></li>
<li><p><code>vcov</code> – either the covariance matrix of the estimated
coefficients, a function used to extract it from the model (e.g.,
<code><a href="https://sandwich.R-Forge.R-project.org/reference/vcovHC.html" class="external-link">sandwich::vcovHC()</a></code> for the robust covariance matrix), or a
string or formula giving a code for extracting the covariance matrix
(see <code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/get_vcov.html" class="external-link">marginaleffects::get_vcov()</a></code> for details). If left
unspecified, the default covariance matrix will be extracted from the
model.</p></li>
<li><p><code>coefs</code> – either a vector of coefficients to be
sampled or a function to extract them from the fitted model. If left
unspecified, the default coefficients will be extracted from the model.
Typically this does not need to be specified.</p></li>
<li><p><code>dist</code> – the name of the distribution from which to
draw the sampled coefficients. Can be <code>"normal"</code> for a normal
distribution or <code>t(#)</code> for a t-distribution, where
<code>#</code> represents the degrees of freedom. If left unspecified,
<code><a href="../reference/sim.html">sim()</a></code> will decide on which distribution makes sense given
the characteristics of the model (the decision is made by
<code><a href="https://easystats.github.io/insight/reference/get_df.html" class="external-link">insight::get_df()</a></code> with <code>type = "wald"</code>).
Typically this does not need to be specified.</p></li>
</ul>
<p>If your model is not supported by <code>clarify</code>, you can omit
the <code>fit</code> argument and just specify the <code>vcov</code> and
<code>coefs</code> argument, which will draw the coefficients from the
distribution named in <code>dist</code> (<code>"normal"</code> by
default).</p>
<p><code><a href="../reference/sim.html">sim()</a></code> uses a random number generator to draw the sampled
coefficients from the sampling distribution, so a seed should be set
using <code><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed()</a></code> to ensure results are replicable across
sessions.</p>
<p>The output of the call to <code><a href="../reference/sim.html">sim()</a></code> is a
<code>clarify_sim</code> object, which contains the sampled
coefficients, the original model fit object if supplied, and the
coefficients and covariance matrix used to sample.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Drawing simulated coefficients using an HC2 robust</span></span>
<span><span class="co"># covariance matrix</span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim.html">sim</a></span><span class="op">(</span><span class="va">fit</span>, vcov <span class="op">=</span> <span class="st">"HC2"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">s</span></span>
<span><span class="co">#&gt; A `clarify_sim` object</span></span>
<span><span class="co">#&gt;  - 10 coefficients, 1000 simulated values</span></span>
<span><span class="co">#&gt;  - sampled distribution: multivariate normal</span></span>
<span><span class="co">#&gt;  - original fitting function call:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; glm(formula = re78_0 ~ treat + age + educ + race + married + </span></span>
<span><span class="co">#&gt;     nodegree + re74 + re75, family = binomial("probit"), data = lalonde)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="computing-derived-quantities">3. Computing derived quantities<a class="anchor" aria-label="anchor" href="#computing-derived-quantities"></a>
</h3>
<p>After sampling the coefficients, we will compute derived quantities
on each set of sampled coefficient and store the result, which
represents a “posterior” distribution of the derived quantity. The core
functionality is provided by <code><a href="../reference/sim_apply.html">sim_apply()</a></code>, which accepts a
<code>clarify_sim</code> object from <code><a href="../reference/sim.html">sim()</a></code> and a function
to compute and return one or more derived quantities, then applies that
function to each set of simulated coefficients. The arguments to
<code><a href="../reference/sim_apply.html">sim_apply()</a></code> are below:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/sim_apply.html">sim_apply</a></span><span class="op">(</span>sim <span class="op">=</span> , FUN <span class="op">=</span> , verbose <span class="op">=</span> , cl <span class="op">=</span> , <span class="va">...</span><span class="op">)</span></span></code></pre></div>
<ul>
<li><p><code>sim</code> – a <code>clarify_sim</code> object; the output
of a call to <code><a href="../reference/sim.html">sim()</a></code>.</p></li>
<li><p><code>FUN</code> – a function that takes in either a model fit
object or a vector of coefficients and returns one or more derived
quantities. The first argument should be named <code>fit</code> to take
in a model fit object or <code>coefs</code> to take in
coefficients.</p></li>
<li><p><code>verbose</code> – whether to display a progress
bar.</p></li>
<li><p><code>cl</code> – an argument that controls parallel processing,
which can be the number of cores to use or a cluster object resulting
from <code><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">parallel::makeCluster()</a></code>.</p></li>
<li><p><code>...</code> - further arguments to
<code>FUN</code>.</p></li>
</ul>
<p>The <code>FUN</code> argument can be specified in one of two ways:
either as a function that takes in a model fit object or a function that
takes in a vector of coefficients. The latter will always work but the
former only works for supported models. When the function takes in a
model fit object, <code><a href="../reference/sim_apply.html">sim_apply()</a></code> will first insert each set of
sampled coefficients into the model fit object and then supply the
modified model to <code>FUN</code>.</p>
<p>For example, let’s say our derived quantity of interest is the
predicted probability of the outcome for participant PSID1. We would
specified our <code>FUN</code> function as follows:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_fun1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">fit</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit</span>, newdata <span class="op">=</span> <span class="va">lalonde</span><span class="op">[</span><span class="st">"PSID1"</span>,<span class="op">]</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The <code>fit</code> object supplied to this function will be one in
which the coefficients have been set to their values in a draw from
their sampling distribution as generated by <code><a href="../reference/sim.html">sim()</a></code>. We then
supply the function to <code><a href="../reference/sim_apply.html">sim_apply()</a></code> to simulate the sampling
distribution of the predicted value of interest:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">est1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_apply.html">sim_apply</a></span><span class="op">(</span><span class="va">s</span>, FUN <span class="op">=</span> <span class="va">sim_fun1</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">est1</span></span>
<span><span class="co">#&gt; A `clarify_est` object (from `sim_apply()`)</span></span>
<span><span class="co">#&gt;  - 1000 simulated values</span></span>
<span><span class="co">#&gt;  - 1 quantity estimated:                 </span></span>
<span><span class="co">#&gt;  PSID1 0.02377322</span></span></code></pre></div>
<p>The resulting <code>clarify_est</code> object contains the simulated
estimates in matrix form as well as the estimate computed on the
original coefficients. We’ll examine the sampling distribution shortly,
but first we’ll demonstrate computing a derived quantity from the
coefficients directly.</p>
<p>The <code>race</code> variable is a factor, and the
<code>black</code> category is used as the reference level, so it’s not
immediately clear whether there is a difference between the coefficients
<code>racehispan</code> and <code>racewhite</code>, which represent the
non-reference categories <code>hispan</code> and <code>white</code>. To
compare these two directly, we can use <code><a href="../reference/sim_apply.html">sim_apply()</a></code> to
compute a derived quantity that corresponds to the difference between
them.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_fun2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">coefs</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">hispan</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="va">coefs</span><span class="op">[</span><span class="st">"racehispan"</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">white</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="va">coefs</span><span class="op">[</span><span class="st">"racewhite"</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"w - h"</span> <span class="op">=</span> <span class="va">white</span> <span class="op">-</span> <span class="va">hispan</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">est2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_apply.html">sim_apply</a></span><span class="op">(</span><span class="va">s</span>, FUN <span class="op">=</span> <span class="va">sim_fun2</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">est2</span></span>
<span><span class="co">#&gt; A `clarify_est` object (from `sim_apply()`)</span></span>
<span><span class="co">#&gt;  - 1000 simulated values</span></span>
<span><span class="co">#&gt;  - 1 quantity estimated:                </span></span>
<span><span class="co">#&gt;  w - h 0.1089068</span></span></code></pre></div>
<p>The function <code>FUN</code> can be arbitrarily complicated and
return as many derived quantities as you want, though the slower each
run of <code>FUN</code> is, the longer it will take to simulate the
derived quantities. Using parallel processing by supplying an argument
to <code>cl</code> can sometimes dramatically speed up evaluation.</p>
<p>There are several functions in <code>clarify</code> that serve as
convenience wrappers for <code><a href="../reference/sim_apply.html">sim_apply()</a></code> to automate some
common derived quantities of interest. These include</p>
<ul>
<li><p><code><a href="../reference/sim_setx.html">sim_setx()</a></code> – computing predicted values and first
differences at representative or user-specified values of the
predictors</p></li>
<li><p><code><a href="../reference/sim_ame.html">sim_ame()</a></code> – computing average marginal means,
contrasts of average marginal means, and average marginal
effects</p></li>
<li><p><code><a href="../reference/sim_adrf.html">sim_adrf()</a></code> – computing average dose-response
functions and average marginal effects functions</p></li>
</ul>
<p>These are described in their own sections below. In addition, there
are functions that have methods for <code>simabsed_est</code> objects,
including <code><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind()</a></code> for combining two
<code>clarify_est</code> objects together and <code><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform()</a></code>
for computing quantities that are derived from the already-computed
derived quantities. These are also described in their own sections
below.</p>
</div>
<div class="section level3">
<h3 id="summarize-and-visualize-the-simulated-distribution">4. Summarize and visualize the simulated distribution<a class="anchor" aria-label="anchor" href="#summarize-and-visualize-the-simulated-distribution"></a>
</h3>
<p>To examine the uncertainty around and perform inference on our
estimated quantities, we can use <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> and
<code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> on the <code>clarify_est</code> object.</p>
<p><code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> displays a density plot of the resulting
estimates across the simulations, with markers identifying the point
estimate (computed using the original coefficients) and, optionally,
uncertainty bounds (which function like confidence or credible interval
bounds). The arguments to <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> are below:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span>x <span class="op">=</span> , parm <span class="op">=</span> , ci <span class="op">=</span> , level <span class="op">=</span> , method <span class="op">=</span> <span class="op">)</span></span></code></pre></div>
<ul>
<li><p><code>x</code> – the <code>clarify_est</code> object (the output
of a call to <code><a href="../reference/sim_apply.html">sim_apply()</a></code>).</p></li>
<li><p><code>parm</code> – the names or indices of the quantities to be
plotted if more than one was estimated in <code><a href="../reference/sim_apply.html">sim_apply()</a></code>; if
unspecified, all will be plotted.</p></li>
<li><p><code>ci</code> – whether to display lines at the uncertainty
bounds. The default is <code>TRUE</code> to display them.</p></li>
<li><p><code>level</code> – if <code>ci</code> is <code>TRUE</code>, the
desired two-sided confidence level. The default is .95 so that that the
bounds are at the .025 and .975 quantiles when <code>method</code> (see
below) is <code>"quantile"</code>.</p></li>
<li><p><code>method</code> – if <code>ci</code> is <code>TRUE</code>,
the method used to compute the bounds. Allowable methods include a
Normal approximation (<code>"wald"</code>) or using the quantiles of the
resulting distribution (<code>"quantile"</code>). The Normal
approximation involves multiplying the standard deviation of the
estimates (i.e., which functions like the standard error of the sampling
distribution) by the critical Z-statistic computed using
<code>(1-level)/2</code> to create a symmetric margin of error around
the point estimate. The default is <code>"quantile"</code> to instead
use quantile-based bounds, which are more appropriate when the
distribution is non-Normal. However, quantile-based bounds may require
more simulations to stabilize.</p></li>
</ul>
<p>Below, we plot the first estimate we computed above, the predicted
probability for participant PSID1:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">est1</span><span class="op">)</span></span></code></pre></div>
<p><img src="clarify_files/figure-html/unnamed-chunk-8-1.png" width="624" style="display: block; margin: auto;"></p>
<p>From the plot, we can see that the distribution of simulated values
is non-Normal and asymmetrical, with no values falling below 0 because
the outcome is a predicted probability. Given its non-Normality, the
quantile-based bounds are clearly more appropriate, as the bounds
computed from the Normal approximation would be outside the bounds of
the estimate. The plot itself is a <code>ggplot</code> object that can
be modified using <code>ggplot2</code> syntax.</p>
<p>We can use <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> to display the value of the point
estimate, the uncertainty bounds, and other statistics that describe the
distribution of estimates. The arguments to <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> are
below:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span>object <span class="op">=</span> , parm <span class="op">=</span> , level <span class="op">=</span> , method <span class="op">=</span> , null <span class="op">=</span> <span class="op">)</span></span></code></pre></div>
<ul>
<li><p><code>object</code> – the <code>clarify_est</code> object (the
output of a call to <code><a href="../reference/sim_apply.html">sim_apply()</a></code>).</p></li>
<li><p><code>parm</code> – the names or indices of the quantities to be
displayed if more than one was estimated in <code><a href="../reference/sim_apply.html">sim_apply()</a></code>; if
unspecified, all will be displayed.</p></li>
<li><p><code>level</code> – the desired two-sided confidence level. The
default is .95 so that that the bounds are at the .025 and .975
quantiles when method (see below) is <code>"quantile"</code>.</p></li>
<li><p><code>method</code> – the method used to compute the uncertainty
bounds. Allowable methods include a Normal approximation
(<code>"wald"</code>) or using the quantiles of the resulting
distribution (<code>"quantile"</code>). See <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code>
above.</p></li>
<li><p><code>null</code> – an optional argument specifying the null
value in a hypothesis test for the estimates. If specified, a p-value
will be computed using either a standard Z-test (if <code>method</code>
is <code>"quantile"</code>) or an inversion of the uncertainty interval.
The default is not to display any p-values.</p></li>
</ul>
<p>We’ll use <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> with the default arguments on our
first <code>simabsed_est</code> object to view the point estimate and
quantile-based uncertainty bounds.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">est1</span><span class="op">)</span></span>
<span><span class="co">#&gt;       Estimate   2.5 %  97.5 %</span></span>
<span><span class="co">#&gt; PSID1  0.02377 0.00362 0.11304</span></span></code></pre></div>
<p>Our second estimated quantity, the difference between two regression
coefficients, is closer to Normally distributed, as the plot below
demonstrates (and would be expected theoretically), so we’ll use the
Normal approximation to test the hypothesis that difference differs from
0.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">est2</span><span class="op">)</span></span></code></pre></div>
<p><img src="clarify_files/figure-html/unnamed-chunk-10-1.png" width="624" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">est2</span>, method <span class="op">=</span> <span class="st">"wald"</span>, null <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt;       Estimate  2.5 % 97.5 % Std. Error Z value P-value</span></span>
<span><span class="co">#&gt; w - h    0.109 -0.309  0.527      0.213    0.51    0.61</span></span></code></pre></div>
<p>The uncertainty intervals and p-values in the <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code>
output are computed using the Normal approximation because we set
<code>method = "wald"</code>, and the p-value for the test that our
estimate is equal to 0 is returned because we set <code>null = 0</code>.
The computed bounds are very close to the quantile-based bound
(displayed in the plot, and can be requested in <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code>
by setting <code>method = "quantile"</code>) because the simulated
sampling distribution is close to Normal.</p>
</div>
<div class="section level2">
<h2 id="sim_apply-wrappers-sim_setx-sim_ame-sim_adrf">
<code>sim_apply()</code> wrappers: <code>sim_setx()</code>,
<code>sim_ame()</code>, <code>sim_adrf()</code><a class="anchor" aria-label="anchor" href="#sim_apply-wrappers-sim_setx-sim_ame-sim_adrf"></a>
</h2>
<p><code><a href="../reference/sim_apply.html">sim_apply()</a></code> can be used to compute the simulated
sampling distribution for any arbitrary derived quantity of interest,
but there are some quantities that are common in applied research and
may otherwise be somewhat challenging to program on their own, so
<code>clarify</code> provides shortcut functions to make computing these
quantities simple. These functions include <code><a href="../reference/sim_setx.html">sim_setx()</a></code>,
<code><a href="../reference/sim_ame.html">sim_ame()</a></code>, and <code><a href="../reference/sim_adrf.html">sim_adrf()</a></code>. Each of these can
only be used when regression models compatible with <code>clarify</code>
are supplied to the original call to <code><a href="../reference/sim.html">sim()</a></code>.</p>
<p>Like <code><a href="../reference/sim_apply.html">sim_apply()</a></code>, each of these functions is named
<code>sim_*()</code>, which signifies that they are to be used on an
object produced by <code><a href="../reference/sim.html">sim()</a></code> (i.e., a <code>clarify_sim</code>
object). (Multiple calls to these functions can be applied to the same
<code>clarify_sim</code> object and combined; see the
<code><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind()</a></code> section below.) These functions are described
below.</p>
<div class="section level3">
<h3 id="sim_setx-predictions-at-representative-values">
<code>sim_setx()</code>: predictions at representative values<a class="anchor" aria-label="anchor" href="#sim_setx-predictions-at-representative-values"></a>
</h3>
<p><code><a href="../reference/sim_setx.html">sim_setx()</a></code> provides an interface to compute predictions
at representative and user-supplied values of the predictors. For
example, we might want to know what the effect of treatment is for a
“typical” individual, which corresponds to the contrast between two
model-based predictions (i.e., one under treatment and one under control
for a unit with “typical” covariate values). This functionality mirrors
the <code>setx()</code> and <code>setx1()</code> functionality of
<code>Zelig</code> and provides similar functionality to functions in
<code>modelbased</code>, <code>emmeans</code>, <code>effects</code>, and
<code>ggeffects</code>.</p>
<p>For each covariate, the user can specify whether they want
predictions at specific values or at “typical” values, which are defined
in <code>clarify</code> as the mode for unordered categorical and binary
variables, the median for ordered categorical variables, and the mean
for continuous variables. Predictions for multiple covariate
combinations can be requested by specifying values that will be used to
create a grid of covariate values. In addition, the “first difference”,
defined here as the difference between predictions for two covariate
combinations, can be computed.</p>
<p>The arguments to <code><a href="../reference/sim_setx.html">sim_setx()</a></code> are as follows:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/sim_setx.html">sim_setx</a></span><span class="op">(</span>sim <span class="op">=</span> , x <span class="op">=</span> , x1 <span class="op">=</span> , outcome <span class="op">=</span> , type <span class="op">=</span> , verbose <span class="op">=</span> , cl <span class="op">=</span> <span class="op">)</span></span></code></pre></div>
<ul>
<li><p><code>sim</code> – a <code>clarify_sim</code> object; the output
of a call to <code><a href="../reference/sim.html">sim()</a></code>.</p></li>
<li><p><code>x</code> – a named list containing the requested values of
the predictors, e.g., <code>list(v1 = 1:4, v2 = "A")</code>. Any
predictors not named will be set at their “typical” value as defined
above.</p></li>
<li><p><code>x1</code> – an optional named list similar to
<code>x</code> except with the value of one predictor changed. When
specified, the first difference is computed between the covariate
combination defined in <code>x</code> (and only one combination is
allowed when <code>x1</code> is specified) and the covariate combination
defined in <code>x1</code>.</p></li>
<li><p><code>outcome</code> – a string containing the name of the
outcome of interest when a multivariate (multiple outcome) model is
supplied to <code><a href="../reference/sim.html">sim()</a></code> or the outcome category of interest when
a multinomial model is supplied to <code><a href="../reference/sim.html">sim()</a></code>. For univariate
(single outcome) and binary outcomes, this is ignored.</p></li>
<li><p><code>type</code> – a string containing the type of predicted
value to return. In most cases, this can be left unspecified to request
predictions on the scale of the outcome.</p></li>
<li><p><code>verbose</code> – whether to display a progress
bar.</p></li>
<li><p><code>cl</code> – an argument that controls parallel processing,
which can be the number of cores to use or a cluster object resulting
from <code><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">parallel::makeCluster()</a></code>.</p></li>
</ul>
<p>Here, we’ll use <code><a href="../reference/sim_setx.html">sim_setx()</a></code> to examine predicted values
of the outcome for control and treated units, at <code>re75</code> set
to 0 and 20000, and <code>race</code> set to “black”.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">est3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_setx.html">sim_setx</a></span><span class="op">(</span><span class="va">s</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>treat <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">1</span>,</span>
<span>                             re75 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">20000</span><span class="op">)</span>,</span>
<span>                             race <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span>,</span>
<span>                 verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>When we use <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> on the resulting output, we can
see the estimates and their uncertainty intervals (calculated using
quantiles by default). To see the complete grid of the predictor values
used in the predictions, which helps to identify the “typical” values of
the other predictors, we can access the <code>"setx"</code> attribute of
the object:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">est3</span>, <span class="st">"setx"</span><span class="op">)</span></span>
<span><span class="co">#&gt;                         treat      age     educ  race married nodegree     re74</span></span>
<span><span class="co">#&gt; treat = 0, re75 = 0         0 27.36319 10.26873 black       0        1 4557.547</span></span>
<span><span class="co">#&gt; treat = 1, re75 = 0         1 27.36319 10.26873 black       0        1 4557.547</span></span>
<span><span class="co">#&gt; treat = 0, re75 = 20000     0 27.36319 10.26873 black       0        1 4557.547</span></span>
<span><span class="co">#&gt; treat = 1, re75 = 20000     1 27.36319 10.26873 black       0        1 4557.547</span></span>
<span><span class="co">#&gt;                          re75</span></span>
<span><span class="co">#&gt; treat = 0, re75 = 0         0</span></span>
<span><span class="co">#&gt; treat = 1, re75 = 0         0</span></span>
<span><span class="co">#&gt; treat = 0, re75 = 20000 20000</span></span>
<span><span class="co">#&gt; treat = 1, re75 = 20000 20000</span></span></code></pre></div>
<p>We can plot the distributions of the simulated values using
<code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code>, which also separates the predictions by the
predictor values (it’s often clearer without the uncertainty
bounds):</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">est3</span>, ci <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="clarify_files/figure-html/unnamed-chunk-13-1.png" width="624" style="display: block; margin: auto;"></p>
<p>We can see again how a delta method or Normal approximation may not
have yielded valid uncertainty intervals given the non-Normality of the
distributions.</p>
<p>If a continuous variable with many levels is included in the grid of
the predictors, something like a dose-response function for a typical
unit can be generated. Below, we set <code>re75</code> to vary from 0 to
20000 in steps of 2000.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">est4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_setx.html">sim_setx</a></span><span class="op">(</span><span class="va">s</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>treat <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">1</span>,</span>
<span>                             re75 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">20000</span>, by <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span>,</span>
<span>                             race <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span>,</span>
<span>                 verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>When we plot the output, we can see how the predictions varies across
the levels of <code>re75</code>:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">est4</span><span class="op">)</span></span></code></pre></div>
<p><img src="clarify_files/figure-html/unnamed-chunk-15-1.png" width="624" style="display: block; margin: auto;"></p>
<p>We’ll return to display average dose-response functions using
<code><a href="../reference/sim_adrf.html">sim_adrf()</a></code> later.</p>
<p>Finally, we can use <code><a href="../reference/sim_setx.html">sim_setx()</a></code> to compute first
differences, the contrast between two covariate combinations. We supply
one covariate profile to <code>x</code> and another to <code>x1</code>,
and <code><a href="../reference/sim_setx.html">sim_setx()</a></code> simulates the two predicted values and their
difference. Below, we simulate first difference for a treated and
control unit who have <code>re75</code> of 0 and typical values of all
other covariates:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">est5</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_setx.html">sim_setx</a></span><span class="op">(</span><span class="va">s</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>treat <span class="op">=</span> <span class="fl">0</span>, re75 <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>                 x1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>treat <span class="op">=</span> <span class="fl">1</span>, re75 <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>                 verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>When we use <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code>, we see the estimates for the
predicted values and their first difference (“FD”):</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">est5</span><span class="op">)</span></span>
<span><span class="co">#&gt;           Estimate   2.5 %  97.5 %</span></span>
<span><span class="co">#&gt; treat = 0   0.2316  0.1630  0.3105</span></span>
<span><span class="co">#&gt; treat = 1   0.1667  0.0911  0.2715</span></span>
<span><span class="co">#&gt; FD         -0.0649 -0.1379  0.0192</span></span></code></pre></div>
<p>It is possible to compute first differences without using
<code>x1</code> using <code><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform()</a></code>, which we describe
later.</p>
</div>
<div class="section level3">
<h3 id="sim_ame-average-marginal-means-and-effects">
<code>sim_ame()</code>: average marginal means and effects<a class="anchor" aria-label="anchor" href="#sim_ame-average-marginal-means-and-effects"></a>
</h3>
<p>Using predicted values and effects at representative values is one
way to summarize regression models, but another way is to compute
average marginal means (AMMs) and average marginal effects (AMEs). The
definitions for these terms may vary and the names for these concepts
differ across sources, but here we define AMMs as the average of the
predicted values for all units after setting one predictor to a chosen
value, and we define AMEs for binary predictors as the contrast of two
AMMs and for continuous predictors as the average of instantaneous rate
of change corresponding to a small change in the predictor from its
observed values across all units<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;In &lt;code&gt;marginaleffects&lt;/code&gt;, AMMs are computed using
&lt;code&gt;predictions()&lt;/code&gt; (not with &lt;code&gt;marginalmeans()&lt;/code&gt;, which
does something closer to &lt;code&gt;&lt;a href="../reference/sim_setx.html"&gt;sim_setx()&lt;/a&gt;&lt;/code&gt;), AMEs for binary
variables are computed using &lt;code&gt;comparisons()&lt;/code&gt;, and AMEs for
continuous variables are computed using &lt;code&gt;marginaleffects()&lt;/code&gt;.
AMMs are sometimes known as average “adjusted” or “counterfactual”
predictions.&lt;/p&gt;'><sup>2</sup></a>.</p>
<p>The arguments to <code><a href="../reference/sim_ame.html">sim_ame()</a></code> are as follows:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/sim_ame.html">sim_ame</a></span><span class="op">(</span>sim <span class="op">=</span> , var <span class="op">=</span> , subset <span class="op">=</span> , contrast <span class="op">=</span> , outcome <span class="op">=</span> ,</span>
<span>        type <span class="op">=</span> , eps <span class="op">=</span> , verbose <span class="op">=</span> , cl <span class="op">=</span> <span class="op">)</span></span></code></pre></div>
<ul>
<li><p><code>sim</code> – a <code>clarify_sim</code> object; the output
of a call to <code><a href="../reference/sim.html">sim()</a></code>.</p></li>
<li><p><code>var</code> – the name of focal variable over which to
compute the AMMs or AMEs, or a list containing the values for which AMMs
should be computed.</p></li>
<li><p><code>subset</code> – a logical vector, evaluated in the original
dataset used to fit the model, defining a subset of units for which the
AMMs or AMEs are to be computed.</p></li>
<li><p><code>contrast</code> – the name of an effect measure used to
contrast AMMs. For continuous outcomes, <code>"diff"</code> requests the
difference in means, but others are available for binary outcomes,
including <code>"rr"</code> for the risk ratio, <code>"or"</code> for
the odds ratio, and <code>"nnt"</code> for the number needed to treat.
If not specified, only AMMs will be computed if the variable named in
<code>var</code> is binary. Ignored when the variable named in
<code>var</code> is continuous because the AME is the only quantity
computed. When <code>var</code> names a multi-category categorical
variable, <code>contrast</code> cannot be used; see the section
describing <code>transfom()</code> for computing contrasts with
them.</p></li>
<li><p><code>outcome</code> – a string containing the name of the
outcome of interest when a multivariate (multiple outcome) model is
supplied to <code><a href="../reference/sim.html">sim()</a></code> or the outcome category of interest when
a multinomial model is supplied to <code><a href="../reference/sim.html">sim()</a></code>. For univariate
(single outcome) and binary outcomes, this is ignored.</p></li>
<li><p><code>type</code> – a string containing the type of predicted
value to return. In most cases, this can be left unspecified to request
predictions on the scale of the outcome.</p></li>
<li><p><code>eps</code> – the value by which the observed values of the
variable named in <code>var</code> are changed when it is continuous to
compute the AME. This usually does not need to be specified.</p></li>
<li><p><code>verbose</code> – whether to display a progress
bar.</p></li>
<li><p><code>cl</code> – an argument that controls parallel processing,
which can be the number of cores to use or a cluster object resulting
from <code><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">parallel::makeCluster()</a></code>.</p></li>
</ul>
<p>Here, we’ll use <code><a href="../reference/sim_ame.html">sim_ame()</a></code> to compute the AME of
<code>treat</code> just among those who were treated (in causal
inference, this is known as the average treatment effect in the treated,
or ATT). We’ll request our estimate to be on the risk ratio scale.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">est6</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_ame.html">sim_ame</a></span><span class="op">(</span><span class="va">s</span>, var <span class="op">=</span> <span class="st">"treat"</span>, subset <span class="op">=</span> <span class="va">treat</span> <span class="op">==</span> <span class="fl">1</span>,</span>
<span>                contrast <span class="op">=</span> <span class="st">"rr"</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>We can use <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> to display the estimates and their
uncertainty intervals. Here, we’ll also use <code>null</code> to include
a test for the null hypothesis that the risk ratio is equal to 1 (but
omit tests for the AMMs by setting their values to <code>NA</code> in
the argument supplied to <code>null</code>).</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">est6</span>, null <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="cn">NA</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;         Estimate 2.5 % 97.5 % P-value</span></span>
<span><span class="co">#&gt; E[Y(0)]    0.319 0.254  0.396       .</span></span>
<span><span class="co">#&gt; E[Y(1)]    0.244 0.190  0.313       .</span></span>
<span><span class="co">#&gt; RR         0.765 0.542  1.078    0.14</span></span></code></pre></div>
<p>Here we see the estimates for the AMMs, <code>E[Y(0)]</code> for the
expected value of the outcome setting <code>treat</code> to 0 and
<code>E[Y(1)]</code> for the expected value of the outcome setting
<code>treat</code> to 1, and the risk ratio <code>RR</code>. The p-value
on the test for the risk ratio aligns with the uncertainty interval
containing 1.</p>
<p>If we instead wanted the risk difference or odds ratio, we would not
have to re-compute the AMMs. Instead, we can use
<code><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform()</a></code> to compute a new derived quantity from the
computed AMMs. The section on <code><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform()</a></code> demonstrates
this.</p>
<p>We can compute the AME for a continuous predictor. Here, we’ll
consider <code>age</code> (just for demonstration; this analysis does
not have a valid interpretation).</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">est7</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_ame.html">sim_ame</a></span><span class="op">(</span><span class="va">s</span>, var <span class="op">=</span> <span class="st">"age"</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>We can use <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> to display the AME estimate and its
uncertainty interval.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">est7</span><span class="op">)</span></span>
<span><span class="co">#&gt;           Estimate   2.5 %  97.5 %</span></span>
<span><span class="co">#&gt; dY/d(age)  0.00618 0.00261 0.00963</span></span></code></pre></div>
<p>The AME is named <code>dY/d(age)</code>, which signifies that a
derivative has been computed (more precisely, the average of the
unit-specific derivatives). This estimate can be interpreted like a
slope in a linear regression model, but as a singe summary of the effect
of a predictor it is too coarse to capture nonlinear relationships. The
section below explains how to compute average dose-response functions
for continuous predictors, which provide a more complete picture of
their effects on an outcome.</p>
</div>
<div class="section level3">
<h3 id="sim_adrf-average-dose-response-functions">
<code>sim_adrf()</code>: average dose-response functions<a class="anchor" aria-label="anchor" href="#sim_adrf-average-dose-response-functions"></a>
</h3>
<p>A dose-response function for an individual is the relationship
between the set value of a continuous focal predictor and the expected
outcome. The average does-response function (ADRF) is the average of the
dose-response functions across all units. Essentially, it is a function
that relates the value of the predictor to the corresponding AMM of the
outcome, the average value of the outcome were all units to be set to
that level of the predictor. ADRFs are the continuous analogue to AMMs
and can be used to provide additional detail about the effect of a
continuous predictor beyond a single AME.</p>
<p>A related quantity is the average marginal effect function (AMEF),
which describes the relationship between a continuous focal predictor
and the AME at that level of the predictor. That is, rather than
describing how the outcome changes as a function of the predictor, it
describes how the <em>effect</em> of the predictor on the outcome
changes as a function of the predictor. It is essentially the derivative
of the ADRF and can be used to identify at what points along the ADRF
the predictor has an effect.</p>
<p>The ADRF and AMEF can be computed using <code><a href="../reference/sim_adrf.html">sim_adrf()</a></code>. The
arguments are below:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/sim_adrf.html">sim_adrf</a></span><span class="op">(</span>sim <span class="op">=</span> , var <span class="op">=</span> , subset <span class="op">=</span> , contrast <span class="op">=</span> , at <span class="op">=</span> ,</span>
<span>         n <span class="op">=</span> , outcome <span class="op">=</span> , type <span class="op">=</span> , eps <span class="op">=</span> , verbose <span class="op">=</span> ,</span>
<span>         cl <span class="op">=</span> <span class="op">)</span></span></code></pre></div>
<ul>
<li><p><code>sim</code> – a <code>clarify_sim</code> object; the output
of a call to <code><a href="../reference/sim.html">sim()</a></code>.</p></li>
<li><p><code>var</code> – the name of focal variable over which to
compute the ADRF or AMEF.</p></li>
<li><p><code>subset</code> – a logical vector, evaluated in the original
dataset used to fit the model, defining a subset of units for which the
ARDF or AMEF is to be computed.</p></li>
<li><p><code>contrast</code> – either <code>"adrf"</code> or
<code>"amef"</code> to request the ADRF or AMEF, respectively. The
default is to request the ADRF.</p></li>
<li><p><code>at</code> – the values of the focal predictor at which to
compute the ADRF or AMEF. This should be a vector of values that the
focal predictor can take on. If unspecified, a vector of <code>n</code>
(see below) equally-spaced values from the minimum to the maximum value
of the predictor will be used. This should typically be used only if
quantities are desired over a subset of the values of the focal
predictor.</p></li>
<li><p><code>n</code> – if <code>at</code> is unspecified, the number of
points along the range of the focal predictor at which to compute the
ADRF or AMEF. More yields smoother functions, but will take longer and
require more memory. The default is 21.</p></li>
<li><p><code>outcome</code> – a string containing the name of the
outcome of interest when a multivariate (multiple outcome) model is
supplied to <code><a href="../reference/sim.html">sim()</a></code> or the outcome category of interest when
a multinomial model is supplied to <code><a href="../reference/sim.html">sim()</a></code>. For univariate
(single outcome) and binary outcomes, this is ignored.</p></li>
<li><p><code>type</code> – a string containing the type of predicted
value to return. In most cases, this can be left unspecified to request
predictions on the scale of the outcome.</p></li>
<li><p><code>eps</code> – the value by which the observed values of the
variable named in <code>var</code> are changed when it is continuous to
compute the AMEF. This usually does not need to be specified.</p></li>
<li><p><code>verbose</code> – whether to display a progress
bar.</p></li>
<li><p><code>cl</code> – an argument that controls parallel processing,
which can be the number of cores to use or a cluster object resulting
from <code><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">parallel::makeCluster()</a></code>.</p></li>
</ul>
<p>Here, we’ll consider <code>age</code> (just for demonstration; this
analysis does not have a valid interpretation) and compute the ADRF and
AMEF of <code>age</code> on the outcome. We’ll only examine ages between
18 and 50, even though the range of <code>age</code> goes slightly
beyond these values. First, we’ll compute the ADRF of <code>age</code>,
which examines how the outcome would vary on average if one set all
unit’s value of <code>age</code> to each value between 18 and 50 (here
we only use even ages).</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">est8</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_adrf.html">sim_adrf</a></span><span class="op">(</span><span class="va">s</span>, var <span class="op">=</span> <span class="st">"age"</span>, contrast <span class="op">=</span> <span class="st">"adrf"</span>,</span>
<span>                 at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">18</span>, <span class="fl">50</span>, by <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>                 verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>We can plot the ADRF using <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code>.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">est8</span><span class="op">)</span></span></code></pre></div>
<p><img src="clarify_files/figure-html/unnamed-chunk-23-1.png" width="624" style="display: block; margin: auto;"></p>
<p>From the plot, we can see that as <code>age</code> increases, the
expected outcome also increases.</p>
<p>We can also examine the AMMs at the requested ages using
<code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code>, which will display all the estimated AMMs by
default, so we will request just the first 4 (<code>age</code>s 18 to
24):</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">est8</span>, parm <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">#&gt;          Estimate 2.5 % 97.5 %</span></span>
<span><span class="co">#&gt; E[Y(18)]    0.178 0.144  0.223</span></span>
<span><span class="co">#&gt; E[Y(20)]    0.189 0.157  0.231</span></span>
<span><span class="co">#&gt; E[Y(22)]    0.200 0.169  0.239</span></span>
<span><span class="co">#&gt; E[Y(24)]    0.211 0.182  0.249</span></span></code></pre></div>
<p>Next we’ll compute the AMEF, the effect of <code>age</code> at each
level of <code>age</code>.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">est9</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_adrf.html">sim_adrf</a></span><span class="op">(</span><span class="va">s</span>, var <span class="op">=</span> <span class="st">"age"</span>, contrast <span class="op">=</span> <span class="st">"amef"</span>,</span>
<span>                 at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">18</span>, <span class="fl">50</span>, by <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>                 verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>We can plot the AMEF using <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code>:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">est9</span><span class="op">)</span></span></code></pre></div>
<p><img src="clarify_files/figure-html/unnamed-chunk-26-1.png" width="624" style="display: block; margin: auto;"></p>
<p>From the plot, we can see the AME of <code>age</code> increases
slightly but is mostly constant across values of <code>age</code>, and
the uncertainty intervals for the AMEs consistently exclude 0.</p>
</div>
</div>
<div class="section level2">
<h2 id="transforming-and-combining-estimates">Transforming and combining estimates<a class="anchor" aria-label="anchor" href="#transforming-and-combining-estimates"></a>
</h2>
<p>Often, our quantities of interest are not just the outputs of the
functions above, but comparisons between them. For example, to test for
moderation of a treatment effect, we may want to compare AMEs in
multiple treatment groups. Or, it might be that we are interested in an
effect described using a different effect measure than the one
originally produced; for example, we may decide we want the risk
difference AME after computing the risk ratio AME. The functions
<code><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform()</a></code> and <code><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind()</a></code> allow users to
transform quantities in a single <code>simabsed_est</code> object and
combine two <code>clarify_est</code> objects. These are essential for
computing quantities that themselves are derived from the derived
quantities computed by the <code>sim_*()</code> functions.</p>
<div class="section level4">
<h4 id="transform">
<code>transform()</code><a class="anchor" aria-label="anchor" href="#transform"></a>
</h4>
<p><code><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform()</a></code> is a generic function in R that is typically
used to create a new variable in a data frame that is a function of
other columns. For example, to compute the binary outcome we used in our
model, we could have run the following:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lalonde</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="va">lalonde</span>, re78_0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">re78</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>(Users familiar with the <code>tidyverse</code> will note the
similarities between <code><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform()</a></code> and
<code><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">dplyr::mutate()</a></code>; only <code><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform()</a></code> can be used
with <code>simabsed_est</code> objects.)</p>
<p>Similarly, to compute a derived or transformed quantity from a
<code>clarify_est</code> object, we can use <code><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform()</a></code>.
Here, we’ll compute the risk difference AME of <code>treat</code>;
previously, we used <code><a href="../reference/sim_ame.html">sim_ame()</a></code> to compute the AMMs and the
risk ratio.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">est6</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="va">est6</span>, RD <span class="op">=</span> <span class="va">`E[Y(1)]`</span> <span class="op">-</span> <span class="va">`E[Y(0)]`</span><span class="op">)</span></span></code></pre></div>
<p>Note that we used tics (```) around the names of the AMMs; this is
necessary when they contain special characters like parentheses or
brackets.</p>
<p>When we run <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> on the output, the new quantity,
which we named “RD”, will be displayed along with the other estimates.
We’ll also set a null value for this quantity.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">est6</span>, null <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="cn">NA</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;         Estimate   2.5 %  97.5 % P-value</span></span>
<span><span class="co">#&gt; E[Y(0)]   0.3195  0.2541  0.3957       .</span></span>
<span><span class="co">#&gt; E[Y(1)]   0.2443  0.1900  0.3132       .</span></span>
<span><span class="co">#&gt; RR        0.7646  0.5420  1.0776    0.14</span></span>
<span><span class="co">#&gt; RD       -0.0752 -0.1711  0.0203    0.14</span></span></code></pre></div>
<p>Something nice about using simulation-based inference with p-values
computed from inverting the confidence intervals is that the p-values
for the risk difference and risk ratio (and any other effect measure for
comparing a pair of values) will always exactly align, thereby ensuring
inference does not depend on the effect measure used.</p>
<p>The same value would be computed if we were to have called
<code><a href="../reference/sim_ame.html">sim_ame()</a></code> on the same <code>clarify_sim</code> object and
requested the risk difference using <code>contrast = "diff"</code>;
using <code><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform()</a></code> saves time because the AMMs are already
computed and stored in the <code>clarify_est</code> object.</p>
</div>
<div class="section level4">
<h4 id="cbind">
<code>cbind()</code><a class="anchor" aria-label="anchor" href="#cbind"></a>
</h4>
<p><code><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind()</a></code> is another generic R function that is typically
used to combine two or more datasets columnwise (i.e., to widen a
dataset). In <code>clarify</code>, <code><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind()</a></code> can be used to
combine two <code>clarify_est</code> objects so that the estimates can
be examined jointly and so that it is possible to compare them directly.
For example, let’s say we computed AMEs in two subgroups and wanted to
compare them. To do so, we would call <code><a href="../reference/sim_ame.html">sim_ame()</a></code> twice, one
for each subset:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># AME of treat with race = "black"</span></span>
<span><span class="va">est10b</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_ame.html">sim_ame</a></span><span class="op">(</span><span class="va">s</span>, var <span class="op">=</span> <span class="st">"treat"</span>, subset <span class="op">=</span> <span class="va">race</span> <span class="op">==</span> <span class="st">"black"</span>,</span>
<span>                  contrast <span class="op">=</span> <span class="st">"diff"</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">est10b</span><span class="op">)</span></span>
<span><span class="co">#&gt;         Estimate   2.5 %  97.5 %</span></span>
<span><span class="co">#&gt; E[Y(0)]   0.3370  0.2621  0.4255</span></span>
<span><span class="co">#&gt; E[Y(1)]   0.2596  0.2010  0.3319</span></span>
<span><span class="co">#&gt; Diff     -0.0774 -0.1798  0.0207</span></span>
<span></span>
<span><span class="co"># AME of treat with race = "hispan"</span></span>
<span><span class="va">est10h</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_ame.html">sim_ame</a></span><span class="op">(</span><span class="va">s</span>, var <span class="op">=</span> <span class="st">"treat"</span>, subset <span class="op">=</span> <span class="va">race</span> <span class="op">==</span> <span class="st">"hispan"</span>,</span>
<span>                  contrast <span class="op">=</span> <span class="st">"diff"</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">est10h</span><span class="op">)</span></span>
<span><span class="co">#&gt;         Estimate   2.5 %  97.5 %</span></span>
<span><span class="co">#&gt; E[Y(0)]   0.1745  0.1015  0.2838</span></span>
<span><span class="co">#&gt; E[Y(1)]   0.1225  0.0588  0.2324</span></span>
<span><span class="co">#&gt; Diff     -0.0520 -0.1225  0.0149</span></span></code></pre></div>
<p>Here, we computed the risk difference for the subgroups
<code>race == "black"</code> and <code>race == "hispan"</code>. If we
wanted to compare the risk differences, we could combine them and
compute a new quantity equal to their difference. We’ll do that
below.</p>
<p>First, we need to rename to quantities in each object so they don’t
overlap; we can do so using <code><a href="https://rdrr.io/r/base/names.html" class="external-link">names()</a></code>, which has a special
method for <code>clarify_est</code> objects.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">est10b</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">est10b</span><span class="op">)</span>, <span class="st">"b"</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">est10h</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">est10h</span><span class="op">)</span>, <span class="st">"h"</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span></span></code></pre></div>
<p>Next, we use <code><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind()</a></code> to bind the objects together.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">est10</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">est10b</span>, <span class="va">est10h</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">est10</span><span class="op">)</span></span>
<span><span class="co">#&gt;           Estimate   2.5 %  97.5 %</span></span>
<span><span class="co">#&gt; E[Y(0)]_b   0.3370  0.2621  0.4255</span></span>
<span><span class="co">#&gt; E[Y(1)]_b   0.2596  0.2010  0.3319</span></span>
<span><span class="co">#&gt; Diff_b     -0.0774 -0.1798  0.0207</span></span>
<span><span class="co">#&gt; E[Y(0)]_h   0.1745  0.1015  0.2838</span></span>
<span><span class="co">#&gt; E[Y(1)]_h   0.1225  0.0588  0.2324</span></span>
<span><span class="co">#&gt; Diff_h     -0.0520 -0.1225  0.0149</span></span></code></pre></div>
<p>Finally, we can use <code><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform()</a></code> to compute the
difference between the risk differences:</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">est10</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="va">est10</span>, `Dh - Db` <span class="op">=</span> <span class="va">Diff_h</span> <span class="op">-</span> <span class="va">Diff_b</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">est10</span>, parm <span class="op">=</span> <span class="st">"Dh - Db"</span><span class="op">)</span></span>
<span><span class="co">#&gt;         Estimate    2.5 %   97.5 %</span></span>
<span><span class="co">#&gt; Dh - Db  0.02540 -0.00458  0.07876</span></span></code></pre></div>
<p>Importantly, <code><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind()</a></code> can only be used to join together
<code>clarify_est</code> objects computed using the same simulated
coefficients (i.e., resulting from the same call to <code><a href="../reference/sim.html">sim()</a></code>).
This preserves the covariance among the estimated quantities, which is
critical for valid inference. That is, <code><a href="../reference/sim.html">sim()</a></code> should only be
called once per model, and all derived quantities should be computed
using its output.</p>
</div>
</div>
<div class="section level2">
<h2 id="using-clarify-with-multiply-imputed-data">Using <code>clarify</code> with multiply imputed data<a class="anchor" aria-label="anchor" href="#using-clarify-with-multiply-imputed-data"></a>
</h2>
<p>Simulation-based inference in multiply imputed data is relatively
straightforward. Simulated coefficients are drawn from the model
estimated in each imputed dataset separately, and then the simulated
coefficients are pooled into a single set of simulated coefficients. In
Bayesian terms, this would be considered “mixing draws” and is the
recommended approach for Bayesian analysis with multiply imputed data
<span class="citation">(Zhou and Reiter 2010)</span>.</p>
<p>Using <code>clarify</code> with multiply imputed data is simple.
Rather than using <code><a href="../reference/sim.html">sim()</a></code>, we use the function
<code><a href="../reference/misim.html">misim()</a></code>. <code><a href="../reference/misim.html">misim()</a></code> functions just like
<code><a href="../reference/sim.html">sim()</a></code> except that it takes in a list of model fits (i.e,
containing a model fit to each imputed dataset) or an object containing
such a list (e.g., a <code>mira</code> object from
<code>mice::with()</code> or a <code>mimira</code> object from
<code>MatchThem::with()</code>). <code><a href="../reference/misim.html">misim()</a></code> simulates
coefficient distributions within each imputed dataset and then appends
them together to a form a single combined set of coefficient draws.</p>
<p><code><a href="../reference/sim_apply.html">sim_apply()</a></code> and its wrappers accept the output of
<code><a href="../reference/misim.html">misim()</a></code> and compute the desired quantity using each set of
coefficients. When these function rely on using a dataset (e.g.,
<code><a href="../reference/sim_ame.html">sim_ame()</a></code>, which averages predicted outcomes across all
units in the dataset used to fit the model), they automatically know to
associate a given coefficient draw with the imputed dataset that was
used to fit the model that produced that draw. In user-written functions
supplied to the <code>FUN</code> argument if <code><a href="../reference/sim_apply.html">sim_apply()</a></code>,
it is important to extract the dataset from the model fit. This is
demonstrated below.</p>
<p>The final estimates of the quantity of interest is computed as the
mean of the estimates computed in each imputed dataset (i.e., using the
original coefficients, not the simulated ones), which is the same
quantity that would be computed using standard pooling rules. This is
not always valid for noncollapsible estimates, like ratios, and so care
should be taken to ensure the mean of the resulting estimates has a
valid interpretation.</p>
<p>The arguments to <code><a href="../reference/misim.html">misim()</a></code> are as follows:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/misim.html">misim</a></span><span class="op">(</span>fitlist <span class="op">=</span> , n <span class="op">=</span> , vcov <span class="op">=</span> , coefs <span class="op">=</span> , dist <span class="op">=</span> <span class="op">)</span></span></code></pre></div>
<ul>
<li><p><code>fitslist</code> – a list of model fits or an accepted
object containing them (e.g., <code>mira</code> object from
<code>mice::with()</code>)</p></li>
<li><p><code>n</code> – the number of simulations to run for each
imputed dataset. The default is 1000, but fewer can be used because the
total number of simulated quantities will be <code>m*n</code>, where
<code>m</code> is the number of imputed datasets.</p></li>
<li><p><code>vcov</code>, <code>coefs</code>, <code>dist</code> – the
same as with <code><a href="../reference/sim.html">sim()</a></code>, except that a list of such arguments
can be supplied to be applied to each imputed dataset.</p></li>
</ul>
<p>Below we illustrate using <code><a href="../reference/misim.html">misim()</a></code> and
<code><a href="../reference/sim_apply.html">sim_apply()</a></code> with multiply imputed data. We’ll use the
<code>africa</code> dataset from the <code>Amelia</code> package.</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://gking.harvard.edu/amelia" class="external-link">Amelia</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: Rcpp</span></span>
<span><span class="co">#&gt; ## </span></span>
<span><span class="co">#&gt; ## Amelia II: Multiple Imputation</span></span>
<span><span class="co">#&gt; ## (Version 1.8.1, built: 2022-11-18)</span></span>
<span><span class="co">#&gt; ## Copyright (C) 2005-2023 James Honaker, Gary King and Matthew Blackwell</span></span>
<span><span class="co">#&gt; ## Refer to http://gking.harvard.edu/amelia/ for more information</span></span>
<span><span class="co">#&gt; ##</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"africa"</span>, package <span class="op">=</span> <span class="st">"Amelia"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Multiple imputation</span></span>
<span><span class="va">a.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Amelia/man/amelia.html" class="external-link">amelia</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">africa</span>, m <span class="op">=</span> <span class="fl">10</span>, cs <span class="op">=</span> <span class="st">"country"</span>,</span>
<span>                ts <span class="op">=</span> <span class="st">"year"</span>, logs <span class="op">=</span> <span class="st">"gdp_pc"</span>, p2s <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fit model to each dataset</span></span>
<span><span class="va">model.list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">a.out</span>, <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">gdp_pc</span> <span class="op">~</span> <span class="va">infl</span> <span class="op">*</span> <span class="va">trade</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Simulate coefficients</span></span>
<span><span class="va">si</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/misim.html">misim</a></span><span class="op">(</span><span class="va">model.list</span>, n <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span></span>
<span><span class="va">si</span></span>
<span><span class="co">#&gt; A `clarify_misim` object</span></span>
<span><span class="co">#&gt;  - 4 coefficients, 10 imputations with 200 simulated values each</span></span>
<span><span class="co">#&gt;  - sampled distributions: multivariate t(116)</span></span></code></pre></div>
<p>The function we’ll be applying to each imputed dataset will be one
that computes the average marginal effect of <code>infl</code>. (We’ll
run the same analysis afterward using <code><a href="../reference/sim_ame.html">sim_ame()</a></code>.)</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">fit</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">#Extract the original dataset using get_predictors()</span></span>
<span>  <span class="va">X</span> <span class="op">&lt;-</span> <span class="fu">insight</span><span class="fu">::</span><span class="fu"><a href="https://easystats.github.io/insight/reference/get_predictors.html" class="external-link">get_predictors</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">p0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit</span>, newdata <span class="op">=</span> <span class="va">X</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#Perturb infl slightly</span></span>
<span>  <span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit</span>, newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="va">X</span>, infl <span class="op">=</span> <span class="va">infl</span> <span class="op">+</span> <span class="fl">1e-5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>AME <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">p1</span> <span class="op">-</span> <span class="va">p0</span><span class="op">)</span> <span class="op">/</span> <span class="fl">1e-5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">est_mi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_apply.html">sim_apply</a></span><span class="op">(</span><span class="va">si</span>, FUN <span class="op">=</span> <span class="va">sim_fun</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">est_mi</span><span class="op">)</span></span>
<span><span class="co">#&gt;     Estimate 2.5 % 97.5 %</span></span>
<span><span class="co">#&gt; AME    -5.66 -9.03  -2.17</span></span></code></pre></div>
<p>Note that <code><a href="../reference/sim_apply.html">sim_apply()</a></code> “knows” which imputation produced
each set of simulated coefficients, so using
<code><a href="https://easystats.github.io/insight/reference/get_predictors.html" class="external-link">insight::get_predictors()</a></code> on the <code>fit</code> supplied
to <code>sim_fun()</code> will use the right dataset. Care should be
taken when analyses restrict each imputed dataset in a different way
(e.g. when matching with a caliper in each one), as the resulting
imputations may not refer to a specific target population and mixing the
draws may be invalid.</p>
<p>Below, we can use <code><a href="../reference/sim_ame.html">sim_ame()</a></code>:</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">est_mi2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_ame.html">sim_ame</a></span><span class="op">(</span><span class="va">si</span>, var <span class="op">=</span> <span class="st">"infl"</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>We get the same results, as expected.</p>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-imaiCommonFrameworkStatistical2008a" class="csl-entry">
Imai, Kosuke, Gary King, and Olivia Lau. 2008. <span>“Toward a Common
Framework for Statistical Analysis and Development.”</span> <em>Journal
of Computational and Graphical Statistics</em> 17 (4): 892–913. <a href="https://doi.org/10.1198/106186008X384898" class="external-link">https://doi.org/10.1198/106186008X384898</a>.
</div>
<div id="ref-kingMakingMostStatistical2000" class="csl-entry">
King, Gary, Michael Tomz, and Jason Wittenberg. 2000. <span>“Making the
Most of Statistical Analyses: Improving Interpretation and
Presentation.”</span> <em>American Journal of Political Science</em> 44
(2): 347–61. <a href="https://doi.org/10.2307/2669316" class="external-link">https://doi.org/10.2307/2669316</a>.
</div>
<div id="ref-tomzClarifySoftwareInterpreting2003" class="csl-entry">
Tomz, Michael, Jason Wittenberg, and Gary King. 2003. <span>“Clarify:
Software for Interpreting and Presenting Statistical Results.”</span>
<em>Journal of Statistical Software</em> 8 (January): 1–30. <a href="https://doi.org/10.18637/jss.v008.i01" class="external-link">https://doi.org/10.18637/jss.v008.i01</a>.
</div>
<div id="ref-zhouNoteBayesianInference2010" class="csl-entry">
Zhou, Xiang, and Jerome P. Reiter. 2010. <span>“A Note on Bayesian
Inference After Multiple Imputation.”</span> <em>The American
Statistician</em> 64 (2): 159–63. <a href="https://doi.org/10.1198/tast.2010.09109" class="external-link">https://doi.org/10.1198/tast.2010.09109</a>.
</div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Noah Greifer, Steven Worthington, Stefano Iacus, Gary King.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
